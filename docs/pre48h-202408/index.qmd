---
title: "Rã«ã‚ˆã‚‹å¤©æ°—äºˆå ±é¢¨ã®ã‚°ãƒ©ãƒ•è¡¨ç¾"
subtitle: "3Dæ£’ã‚°ãƒ©ãƒ•ï¼‹åœ°å›³ã®ä¾‹"
author: "ã‚ãã‚‹ï¼ˆpaithiov909ï¼‰"
date: "2024-10-19"
date-format: long
lang: ja
format:
  aesthetic-revealjs:
    transition: fade
    slide-number: "c/t"
    overview: true
    chalkboard: false
    progress: true
    history: false
    theme: [default, custom.scss]
    include-in-header: header.html
    embed-resources: false
    link-external-newwindow: true
    pointer:
      color: "#FA7785"
      pointerSize: 24
revealjs-plugins:
  - pointer
knitr:
  opts_chunk:
    tidy: "styler"
    collapse: true
    comment: "#>"
---

## èª°ï¼Ÿ

:::{.aesthetic-windows-95-container-indent}
:::{.columns}

:::{.column width="30%"}
![](https://rawcdn.githack.com/paithiov909/paithiov909/f5342cd61b45e29c34b17fc11c9bc1766eacb441/avatar.jpg){.rounded-full}
:::

:::{.column width="70%"}
- ã‚ãã‚‹ï¼ˆ[paithiov909](https://github.com/paithiov909)ï¼‰ã¨ã„ã†ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã—ã¦ã„ã‚‹
- Rãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã¤ãã£ãŸã‚Šã—ã¦ã„ã‚‹
  - [gibasa: A plain 'Rcpp' wrapper of 'MeCab'](https://github.com/paithiov909/gibasa/)
  - [audubon: An R package for Japanese text processing](https://github.com/paithiov909/audubon)
:::

:::
:::

## ä»Šå¹´ã®å¤ã‚’ãµã‚Šã‹ãˆã‚‹ğŸ

### ãƒãƒ†ã¦ãŸã‚‰å¤ã¯çµ‚ã‚ã£ã¦ã„ãŸ

:::{.aesthetic-windows-95-container-indent .fragment .fade-up}
[ã“ã®å¤ã«ã‚„ã£ãŸã“ã¨ï¼š]{.aesthetic-pepsi-cola-color}

- [WebR](https://docs.r-wasm.org/webr/latest/)ã‚’[Tauri v2](https://tauri.app/)ã‚¢ãƒ—ãƒªã®ä¸­ã§ä½¿ã£ã¦ã¿ã‚‹
  - [paithiov909/bnbkchagama: [WIP] Attempt to use WebR in Tauri v2 app](https://github.com/paithiov909/bnbkchagama)
- å†·æˆ¿ã®åŠ¹ã„ãŸéƒ¨å±‹ã§ã‚½ã‚·ãƒ£ã‚²
:::

## å°é¢¨ã™ã”ã‹ã£ãŸğŸŒ€

:::{layout-ncol=2}
![](tenki-1.webp){.fragment .fade-up}

![](tenki-2.webp){.fragment .fade-up}
:::

[ç”»åƒï¼š[å°é¢¨10å·ã¾ã¨ã‚ã€€è¨˜éŒ²çš„ãªå¤§é›¨ãƒ»æš´é¢¨ã€€ç§‹ã‚‚å°é¢¨ã®ç™ºç”Ÿã—ã‚„ã™ã„çŠ¶æ³ç¶šãã€€å‹•å‘ã«æ³¨æ„(æ°—è±¡äºˆå ±å£« å‰ç”°ã€€å‹æµ· 2024å¹´09æœˆ02æ—¥) - æ—¥æœ¬æ°—è±¡å”ä¼š tenki.jp](https://tenki.jp/forecaster/t_yoshida/2024/09/02/30414.html)]{style="font-size: 0.8em;"}

## ä»Šæ—¥ã‚„ã‚‹ã“ã¨ğŸ¯

### ã“ã†ã„ã†è¡¨ç¾ã‚’[R]{.aesthetic-pepsi-red-color}ã§ã‚„ã‚ŠãŸã„

![ç”»åƒï¼šhttps://x.com/wni_jp/status/1425815449036476420 ã‹ã‚‰](E8mBv25UcAIIM-p.png)

## å…·ä½“çš„ã«ğŸ¥…

### ç©ç®—é™æ°´é‡ã®3Dæ£’ã‚°ãƒ©ãƒ•ï¼‹åœ°å›³ã‚’æã

:::{.aesthetic-windows-95-container-indent}
- [ç›´è¿‘48æ™‚é–“ã®ç©ç®—é™æ°´é‡ï¼ˆ48æ™‚é–“é™æ°´é‡ï¼‰ã®ã‚°ãƒ©ãƒ•]{.aesthetic-pepsi-cola-color}
  - 3Dè¡¨ç¾ï¼ˆZ=0ã®XYå¹³é¢ä¸Šã«åœ°å›³ã‚’æãã€Zè»¸æ–¹å‘ã«å‚ç›´ã«æ£’ã‚°ãƒ©ãƒ•ã‚’ç”Ÿã‚„ã™ï¼‰
  - åœ°å›³ä¸Šã§è¦³æ¸¬åœ°ç‚¹ãŒã‚ã‚‹ä½ç½®ã«æ£’ã‚°ãƒ©ãƒ•ã‚’æã
  - æ£’ã¯é™æ°´é‡ã§éšç´šã«åˆ†ã‘ã¦è‰²ã‚’ã¤ã‘ã‚‹
:::

## ã©ã†ã‚„ã£ã¦â“

### å®Ÿã¯Excelã§ã§ãã‚‹ã®ã ãŒâ€¦

:::{.aesthetic-windows-95-container-indent .fragment .fade-up}
- CSVãƒ‡ãƒ¼ã‚¿ãŒ[æ°—è±¡åºï½œæœ€æ–°ã®æ°—è±¡ãƒ‡ãƒ¼ã‚¿](https://www.data.jma.go.jp/stats/data/mdrr/pre_rct/index24_rct.html)ã‚ãŸã‚Šã‹ã‚‰å–å¾—ã§ãã‚‹
  - [jmastats](https://uribo.github.io/jmastats/index.html)ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§è¡Œã‘ãã†ã ãŒã€ã“ã“ã§ã¯æ‰‹å‹•ã§DLã—ã¦ãŠã„ãŸ
- åœ°å›³ã®è¡¨ç¾ã«ã¯[Mapbox GL JS](https://www.mapbox.com/)ã¨ã„ã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ã†
  - Rã‹ã‚‰ã¯[mapboxer](https://crazycapivara.github.io/mapboxer/index.html)ã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦åˆ©ç”¨ã§ãã‚‹
  - ggplot2ï¼ˆ[rayshader](https://github.com/tylermorganwall/rayshader)ã€[ggrgl](https://github.com/coolbutuseless/ggrgl)ãªã©ï¼Ÿï¼‰ã‚„plotlyã§ã‚‚åœ°å›³ã¯æã‘ã‚‹ãŒã€åœ°å›³ã®Zè»¸æ–¹å‘ã«æ£’ã‚°ãƒ©ãƒ•ã‚’ç«‹ã¦ã‚‹è¡¨ç¾ãŒé›£ã—ã„
:::

## é™æ°´é‡ã®è‰²åˆ†ã‘ğŸš¥

ã¨ã‚Šã‚ãˆãšé©å½“ã«è‰²åˆ†ã‘ã™ã‚‹é–¢æ•°ã‚’ç”¨æ„ã—ã¦ãŠãã€‚
ã“ã®é–¢æ•°ã®æˆ»ã‚Šå€¤ã¯`#RRGGBB`ã¨ã„ã†å½¢ã®ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰

```{r}
#| label: val2colcode
#| echo: true
val2colcode <- \(val) {
  dplyr::case_when(
    val >= 300 ~ "purple",
    dplyr::between(val, 200, 300) ~ "red",
    dplyr::between(val, 150, 200) ~ "yellow",
    dplyr::between(val, 100, 150) ~ "green",
    dplyr::between(val, 50, 100) ~ "blue",
    dplyr::between(val, 1, 50) ~ "cyan",
    .default = "gray"
  ) |>
    # å®Ÿéš›ã¯7è‰²ã ã‘å¤‰æ›ã™ã‚Œã°ã‚ˆã„ã®ã§ã€
    # ã“ã®æ›¸ãæ–¹ã¯å‡¦ç†ã¨ã—ã¦ã¯ç„¡é§„ãŒå¤šã„
    col2rgb() |>
    t() |>
    rgb(maxColorValue = 255)
}
```

## ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ğŸ“–

`jmastats::stations`ã¨çµåˆã—ã¦è¦³æ¸¬åœ°ç‚¹ã®åº§æ¨™ã‚’ä»˜ã‘ã¦ãŠã

```{r}
#| label: read-data
#| echo: true
#| code-fold: false
pre48h <-
  readr::read_csv(
    here::here("pre48h00_rct.csv"), # 9/1 13æ™‚æ›´æ–°åˆ†ã®ãƒ‡ãƒ¼ã‚¿
    locale = readr::locale(encoding = "Shift_JIS") # Why are you using Shift_JIS??
  ) |>
  dplyr::select(`è¦³æ¸¬æ‰€ç•ªå·`, `åœ°ç‚¹`, `ç¾åœ¨å€¤(mm)`) |>
  dplyr::rename_with(~ c("station_no", "station_name_label", "val")) |>
  dplyr::filter(!is.na(val)) |> # æ¬ æ¸¬ã¯å‰Šé™¤ã™ã‚‹
  dplyr::left_join(
    dplyr::distinct(
      jmastats::stations,
      station_no,
      .keep_all = TRUE
    ),
    by = dplyr::join_by(station_no == station_no)
  ) |>
  dplyr::distinct(geometry, .keep_all = TRUE) # ä½ç½®ã§å†åº¦`distinct`ã™ã‚‹
```


## ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢ğŸ”¨

ãã‚Œãã‚Œã®è¦³æ¸¬åœ°ç‚¹ã«å¯¾å¿œã™ã‚‹æ£’ã‚°ãƒ©ãƒ•ãã®ã‚‚ã®ã‚’åœ°ç‰©ï¼ˆPOLYGONï¼‰ã¨ã—ã¦ç”¨æ„ã™ã‚‹ã€‚ã“ã“ã§ã¯ã€è¦³æ¸¬åœ°ç‚¹ã‚’`sf::st_buffer`ã§åºƒã’ã‚‹

```{r}
#| label: modify-data
#| echo: true
#| code-fold: false
pre48h <- pre48h |>
  dplyr::mutate(
    station_name_label = station_name_label,
    height = val * 600, # åœ°ç‰©ã®é«˜ã•ã€‚ã“ã“ã§ã¯é©å½“ã«`600`ã‚’ã‹ã‘ã¦ãŠã
    colour = val2colcode(val), # ã•ã£ãã®è‰²åˆ†ã‘é–¢æ•°
    geometry = geometry,
    .keep = "used"
  ) |>
  sf::st_as_sf() |> # `sf`ã«å¤‰æ›ã—ãªãŠã™
  sf::st_buffer(4000) # æ£’ã‚°ãƒ©ãƒ•ã«ãªã‚‹POLYGONã‚’ã¤ãã‚‹
```

## ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªğŸ”

```{r}
#| label: check-data
#| echo: true
#| code-fold: false
pre48h
```

## ggplot2ã§ã®åœ°å›³è¡¨ç¾ğŸ—¾

ã“ã‚Œã‚’ç´ ç›´ã«ggplot2ã§æç”»ã™ã‚‹ã¨ã€è¦³æ¸¬åœ°ç‚¹ãŒå…¨å›½å„åœ°ã«æ•£ã‚‰ã°ã£ã¦ã„ã‚‹ã‚ˆã†ã™ã‚’ç¢ºèªã§ãã‚‹

```{r}
#| label: plot-stations
#| echo: true
#| code-fold: false
#| output-location: slide
library(ggplot2)

gp <- ggplot(pre48h) +
  geom_sf(aes(fill = factor(colour))) +
  theme_grey() +
  labs(title = "ç‚¹ã®è‰²ã¯æŒ‡å®šã—ãŸã‚‚ã®ã¨ã¯é•ã†ã‚ˆï¼")

gp
```

## æ±æµ·é“æ–°å¹¹ç·šã®ãƒ‡ãƒ¼ã‚¿ğŸš…

[æ±æµ·é“æ–°å¹¹ç·šãŒé‹ä¼‘ã—ã¦å¤§å¤‰ã ã£ãŸ](https://www3.nhk.or.jp/news/html/20240904/k10014571961000.html)ã‚‰ã—ã„ã®ã§ã€æ–°å¹¹ç·šã®è·¯ç·šå›³ã‚’é‡ã­ã¦æã„ã¦ã¿ãŸã„ã€‚[jprailway](https://github.com/paithiov909/jprailway)ã¨ã„ã†è‡ªä½œãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ãŠã

```{r jprailway}
#| label: read-jprailway
#| echo: true
#| code-fold: false
# é‰„é“åŒºé–“ã®sf (LINESTRING)
tkd_line <- jprailway::polylines |>
  dplyr::filter(name == "æ±æµ·é“æ–°å¹¹ç·š")

# é§…ã®sf (POLYGON). ãŸã ã—ã€ã“ã“ã§ã¯ä»£è¡¨ç‚¹ã®åº§æ¨™ã‚’ä½¿ã†
tkd_station <- jprailway::stations |>
  dplyr::semi_join(
    jprailway::lines |>
      dplyr::filter(name == "æ±æµ·é“æ–°å¹¹ç·š") |>
      tidyr::unnest(station_list, names_sep = "_"),
    by = c("code" = "station_list_code")
  ) |>
  dplyr::select(code, name, lat, lng) |>
  sf::st_drop_geometry()
```

## æ±æµ·é“æ–°å¹¹ç·šã®è·¯ç·šå›³ğŸš…

ã“ã‚Œã¯ã€ã“ã‚“ãªæ„Ÿã˜ã®ãƒ‡ãƒ¼ã‚¿

```{r}
#| label: plot-jprailway
#| echo: true
#| code-fold: true
#| output-location: default
gp +
  geom_sf(data = tkd_line) +
  geom_point(aes(x = lng, y = lat), data = tkd_station) +
  ggrepel::geom_label_repel(aes(x = lng, y = lat, label = name), data = tkd_station) +
  coord_sf(xlim = c(135, 140), ylim = c(34.5, 35.8)) +
  labs(
    title = "æ±æµ·é“æ–°å¹¹ç·šã®åœè»Šé§…",
    caption = paste(
      "å‡ºå…¸ï¼šå›½åœŸæ•°å€¤æƒ…å ±ï¼ˆé‰„é“ãƒ‡ãƒ¼ã‚¿ï¼‰ï¼ˆå›½åœŸäº¤é€šçœï¼‰",
      "https://nlftp.mlit.go.jp/ksj/gml/datalist/KsjTmplt-N02-v2_3.html",
      sep = "\n"
    )
  )
```

## Mapbox GL JSã¨ã¯ğŸ

```{r}
#| label: map-demo-1
#| echo: true
#| code-fold: true
library(mapboxer)

jpmap <-
  mapboxer::mapboxer(
    style = basemaps$Carto$voyager,
    center = c(140, 40),
    zoom = 3.2,
    pitch = 60.00,
    bearing = -12.0
  )
```

```{r}
#| label: map-demo-2
#| echo: true
#| code-fold: true
jpmap <- jpmap |>
  mapboxer::add_line_layer(
    id = "tkd_line",
    source = tkd_line |>
      mapboxer::as_mapbox_source(),
    line_color = "#000000",
    line_opacity = 0.8
  ) |>
  mapboxer::add_circle_layer(
    id = "tkd_station",
    source = tkd_station |>
      mapboxer::as_mapbox_source(),
    circle_color = "#000000",
    circle_opacity = 0.8
  ) |>
  mapboxer::add_tooltips(
    layer_id = "tkd_station",
    tooltip = "{{name}}"
  )
```

æœ¬æ¥ã¯ã“ã‚“ãªé›°å›²æ°—ã§åœ°å›³ã‚’æç”»ã™ã‚‹ãŸã‚ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

ã“ã®åœ°å›³ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã¯ã€å·¦ã‚¯ãƒªãƒƒã‚¯ã§ã®ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ‘ãƒ³ã€å³ã‚¯ãƒªãƒƒã‚¯ã§ã®ãƒ‰ãƒ©ãƒƒã‚°ã§å›è»¢ã€ãƒ›ã‚¤ãƒ¼ãƒ«ã§å€ç‡ã®å¤‰æ›´ãŒã§ãã‚‹

## Mapbox GL JSã«ã‚ˆã‚‹åœ°å›³ğŸ¨

â€»ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®é«˜ã•ã‚„å¹…ãŒå°ã•ã„å ´åˆã€ãƒšãƒ¼ã‚¸ã‚’å†èª­è¾¼ã¿ã—ã¦ã¿ã¦ãã ã•ã„

```{r}
#| label: map-demo-3
#| echo: false
jpmap
```

## é«˜ã•ãŒã‚ã‚‹åœ°ç‰©ã‚’æãğŸ—¼

Mapbox GL JSã«ã¯ã€åœ°å›³ã«ã‚°ãƒ©ãƒ•ã‚’é‡ã­ã‚‹ã“ã¨ãŒã§ãã‚‹ç‰¹åˆ¥ãªæ©Ÿèƒ½ãŒã‚ã‚‹ã‚ã‘ã§ã¯ãªã„ãŒã€[fill-extrusion](https://docs.mapbox.com/style-spec/reference/layers/#fill-extrusion)ã¨ã„ã†ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨ã—ã¦è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€é«˜ã•ãŒã‚ã‚‹åœ°ç‰©ã‚’æç”»ã™ã‚‹ã“ã¨ãŒã§ãã‚‹

![â†‘æœ¬æ¥ã¯ã“ã†ã„ã£ãŸè¡¨ç¾ã‚’ã™ã‚‹ãŸã‚ã®æ©Ÿèƒ½ã‚‰ã—ã„](layer-fill-extrusion.6492bb9.960.png)

## 3Dæ£’ã‚°ãƒ©ãƒ•ï¼‹åœ°å›³ã®è¡¨ç¾ğŸ“Š

```{r}
#| label: extrusion-demo-1
#| echo: false
jpmap <-
  mapboxer::mapboxer(
    style = basemaps$Carto$voyager,
    center = c(140, 40),
    zoom = 3.2,
    pitch = 60.00,
    bearing = -12.0
  ) |>
  mapboxer::add_line_layer(
    id = "tkd_line",
    source = tkd_line |>
      mapboxer::as_mapbox_source(),
    line_color = "#000000",
    line_opacity = 0.8
  ) |>
  mapboxer::add_circle_layer(
    id = "tkd_station",
    source = tkd_station |>
      mapboxer::as_mapbox_source(),
    circle_color = "#000000",
    circle_opacity = 0.8
  ) |>
  mapboxer::add_tooltips(
    layer_id = "tkd_station",
    tooltip = "{{name}}"
  )
```

```{r}
#| label: extrusion-demo-2
#| echo: true
#| code-fold: true
jpmap <- jpmap |>
  mapboxer::add_source(
    id = "extrusion_src",
    source = pre48h |>
      mapboxer::as_mapbox_source()
  ) |>
  mapboxer::add_layer(
    list(
      id = "extrusion",
      type = "fill-extrusion",
      source = "extrusion_src",
      paint = list(
        "fill-extrusion-color" = list("get", "colour"),
        "fill-extrusion-height" = list("get", "height"),
        "fill-extrusion-base" = 0,
        "fill-extrusion-opacity" = 0.6
      )
    )
  )
```

```{r}
#| label: extrusion-demo-3
#| echo: true
#| code-fold: true
#| output-location: slide
jpmap |>
  mapboxer::add_tooltips(
    layer_id = "extrusion",
    tooltip = "è¦³æ¸¬æ‰€: {{station_name_label}}<br />é™æ°´é‡: {{val}} mm"
  )
```

[ã“ã¡ã‚‰ã®ãƒ–ãƒ­ã‚°è¨˜äº‹](https://hirosaji.hatenablog.com/entry/2021/02/28/170637)ã®ã‚„ã‚Šæ–¹ã‚’å‚è€ƒã«ã€æ£’ã‚°ãƒ©ãƒ•ã®æ£’ãã®ã‚‚ã®ã‚’åœ°ç‰©ï¼ˆPOLYGONï¼‰ã¨ã—ã¦ã‚ã‚‰ã‹ã˜ã‚ç”¨æ„ã—ãŸã®ã§ã€ãã‚Œã‚’æç”»ã™ã‚‹ã“ã¨ã§ã€3Dæ£’ã‚°ãƒ©ãƒ•ã®ã‚ˆã†ãªè¡¨ç¾ãŒã§ãã‚‹

## ã¾ã¨ã‚ğŸŒ‚

### [R]{.aesthetic-pepsi-red-color}ã§å¤©æ°—äºˆå ±é¢¨ã®ã‚°ãƒ©ãƒ•ã‚’æã‘ãŸï¼ï¼

:::{.aesthetic-windows-95-container-indent}
- ãŸã ã—ã€Mapbox GL JSã‚’ä½¿ã†å ´åˆã¯`fill-extrusion`ã§ã®åŠ›æŠ€ã«ã‚ˆã‚‹
- Rã§3Dæ£’ã‚°ãƒ©ãƒ•ï¼‹åœ°å›³ã®è¡¨ç¾ã¯ãªã‹ãªã‹å¤§å¤‰
  - ã‚‚ã—ã‹ã—ãŸã‚‰[deckgl](https://github.com/crazycapivara/deckgl)ã®[ColumnLayer](https://deck.gl/docs/api-reference/layers/column-layer)ã‚’ä½¿ã†ã®ãŒæ¥½ã‹ã‚‚ã—ã‚Œãªã„
- ã§ã‚‚ã€å¤‰ãªå›³ã‚’è‡ªåŠ›ã§æãã¨[R]{.aesthetic-pepsi-red-color}åŠ›ã®é«˜ã¾ã‚Šã‚’æ„Ÿã˜ã‚‰ã‚Œã‚‹
:::

---

```{=html}
<div>
  <h2 class="aesthetic-25-transparent-color aesthetic-effect-text-glitch" data-glitch="Enjoy!!">Enjoy!!</h2>
</div>
```

```{r}
#| label: hexfont
#| echo: false
fonts <- hexfont::unifont(
  jp = TRUE,
  ucp = c(bittermelon::block2ucp("Mahjong Tiles"), bittermelon::str2ucp("Enjoy! "))
)
moji <- fonts[bittermelon::str2ucp("Enjoy!!")] |>
  bittermelon::bm_call(cbind)
tile <- fonts[bittermelon::str2ucp("ğŸ€ˆğŸ€‰ğŸ€ŠğŸ€ˆğŸ€‰ğŸ€ŠğŸ€ˆğŸ€‰ğŸ€ŠğŸ€šğŸ€šğŸ€šğŸ€‹ ğŸ€‹")] |>
  bittermelon::bm_call(cbind)

ra <- rbind(moji, tile) |>
  as.raster()
plot(ra)
```
